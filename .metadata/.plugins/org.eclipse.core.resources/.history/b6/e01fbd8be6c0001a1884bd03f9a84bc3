package com.duicaishijiao.crawler;

import java.util.List;

import us.codecraft.webmagic.Page;
import us.codecraft.webmagic.Site;
import us.codecraft.webmagic.processor.PageProcessor;
import us.codecraft.webmagic.selector.Selectable;


public class NanGuaRepoPageProcessor implements PageProcessor , RepoEntrance{
	
	private String entrance = "https://www.ooe.la/vodtype/1/";
	
	@Override
	public String getEntrance() {
		return this.entrance;
	}
	
	@Override
	public void process(Page page) {
		Selectable selectable = page.getHtml().$("div.page_info");
		String em = selectable.$("em").get();
		if(em!=null) {			
			em = em.substring(em.indexOf("当前")+3);
			String[] ss = em.split("/",2);
			int pageNum = Integer.parseInt(ss[0]);
			int totalPage = Integer.parseInt(ss[1].substring(0, ss[1].length()-1));
			if(pageNum<totalPage && pageNum<=50)
		}
		
		
		Selectable selectable = page.getHtml().$("div.inline-video__player");
	 	List<String> img = selectable.$("div.inline-video__poster img","src").all();
	 	List<String> src = selectable.$("video","data-src").all();
	 	List<String> title = selectable.$("video","miuititle").all();
	 	if(!title.isEmpty()) {	 		
	 		page.putField("title", title.get(title.size()-1));
	 		page.putField("img", img.get(img.size()-1));
	 		page.putField("src", src.get(src.size()-1));
	 		String url = page.getRequest().getUrl();
	 		page.putField("id", url.substring(url.indexOf("&id=")+4,url.indexOf("&",url.indexOf("&id=")+5)));
	 	}
		page.addTargetRequests(page.getHtml().links().regex("#page=inline-video-detail&id=V_.+").all());
	}

	@Override
	public Site getSite() {
		return Site.me()
				.setRetrySleepTime(3).setSleepTime(100);
	}
	
}
